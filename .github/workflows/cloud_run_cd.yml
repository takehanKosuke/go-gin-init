# cloudRunç”¨ã®cd ymlã§ã™ã€‚
# github actionã«
# GCP_PROJECT_ID = ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
# GCP_SA_KEY = credential.jsonã‚’â†’ã€€`cat base64 ./path/to/credential.json` ã§base64ã«å¤‰æ›´ã—ãã®å¤‰æ›´ã•ã‚ŒãŸbase64ã‚³ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã™ã‚‹
# PRD_SERVER_NAME = prdç’°å¢ƒç”¨ã®cloud runã‚µãƒ¼ãƒãƒ¼å
# STG_SERVER_NAME = stgç’°å¢ƒç”¨ã®cloud runã‚µãƒ¼ãƒãƒ¼å

# SLACK_WEBHOOK_URL = slackã®webhookURLã‚’è¿½åŠ 

name: go-ci

on:
  push:
    branches:
      # - main
      # - develop
      # â†“ä½¿ç”¨ã™ã‚‹ã¨ãã¯å‰Šé™¤ã™ã‚‹ã“ã¨
      - tmp

env:
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
  SLACK_ICON: https://pbs.twimg.com/profile_images/907259030678142982/cwfh5ljg_400x400.jpg
  # â†“é€ä¿¡ã™ã‚‹ãƒãƒ£ãƒ³ãƒãƒ«åã‚’åŠ ç­†ã™ã‚‹ã“ã¨
  SLACK_CHANNEL: ãƒãƒ£ãƒ³ãƒãƒ«å
  SLACK_USERNAME: Deploy Bot


jobs:
  deploy:
    needs: [build, format, test]
    name: deploy
    runs-on: ubuntu-latest
    steps:
      - name: stgç’°å¢ƒç”¨ã®ç’°å¢ƒå¤‰æ•°ã‚’ã‚»ãƒƒãƒˆ
        if: github.ref == 'refs/heads/develop'
        run: echo "SERVER_NAME=${{ secrets.STG_SERVER_NAME }}" >> $GITHUB_ENV
      - name: productionç’°å¢ƒç”¨ã®ç’°å¢ƒå¤‰æ•°ã‚’ã‚»ãƒƒãƒˆ
        if: github.ref == 'refs/heads/main'
        run: echo "SERVER_NAME=${{ secrets.PRD_SERVER_NAME }}" >> $GITHUB_ENV

      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@master
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Configure docker to use the gcloud cli
        run: gcloud auth configure-docker --quiet

      - name: docker imageã‚’ãƒ“ãƒ«ãƒ‰
        run: docker build . -t asia.gcr.io/${{ secrets.GCP_PROJECT_ID }}/$SERVER_NAME:${{ github.sha }} -t asia.gcr.io/${{ secrets.GCP_PROJECT_ID }}/$SERVER_NAME:latest

      - name: docker imageã‚’ãƒ—ãƒƒã‚·ãƒ¥
        run: docker push asia.gcr.io/${{ secrets.GCP_PROJECT_ID }}/$SERVER_NAME:${{ github.sha }} && docker push asia.gcr.io/${{ secrets.GCP_PROJECT_ID }}/$SERVER_NAME:latest

      - name: Cloud Runã«ãƒ‡ãƒ—ãƒ­ã‚¤
        run: |
          gcloud run deploy $SERVER_NAME \
            --image asia.gcr.io/${{ secrets.GCP_PROJECT_ID }}/$SERVER_NAME \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --region asia-northeast1 \
            --platform managed \
            --quiet


      # é©åˆ‡ã«å‡¦ç†ãŒçµ‚äº†ã—ãŸã¨ãã«slackã«æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é£›ã°ã™
      - name: Slack Notification on Success
        if: success()
        uses: rtCamp/action-slack-notify@v2.0.2
        env:
          SLACK_TITLE: Deploy SuccessğŸ‰
          SLACK_COLOR: good

      # å‡¦ç†ãŒç•°å¸¸çµ‚äº†ã—ãŸã¨ãã«slackã«å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é£›ã°ã™
      - name: Slack Notification on Failure
        uses: rtCamp/action-slack-notify@v2.0.2
        if: failure()
        env:
          SLACK_TITLE: âš ï¸Deploy Failure
          SLACK_COLOR: danger
          SLACK_MESSAGE: <!channel>ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç¢ºèªã—ã¦ãã ã•ã„
